<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#6200ee"><meta name="author" content="菠萝"><meta name="copyright" content="菠萝"><meta name="generator" content="Hexo 7.0.0"><meta name="theme" content="hexo-theme-yun"><title>flutter | 牵风散步の雲</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#6200ee"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"kiritoabc.github.io","root":"/","title":"菠萝的小站","version":"1.10.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><meta name="description" content="flutter网络框架dio v5.3.3 dio 是一个强大的 HTTP 网络请求库，支持全局配置、Restful API、FormData、拦截器、 请求取消、Cookie 管理、文件上传&#x2F;下载、超时、自定义适配器、转换器等。">
<meta property="og:type" content="article">
<meta property="og:title" content="flutter">
<meta property="og:url" content="https://kiritoabc.github.io/2023/11/13/Flutter/index.html">
<meta property="og:site_name" content="牵风散步の雲">
<meta property="og:description" content="flutter网络框架dio v5.3.3 dio 是一个强大的 HTTP 网络请求库，支持全局配置、Restful API、FormData、拦截器、 请求取消、Cookie 管理、文件上传&#x2F;下载、超时、自定义适配器、转换器等。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-11-13T08:51:13.487Z">
<meta property="article:modified_time" content="2023-11-13T08:51:13.487Z">
<meta property="article:author" content="菠萝">
<meta property="article:tag" content="安卓开发">
<meta name="twitter:card" content="summary"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info mickey-mouse"><a class="site-author-avatar" href="/about/" title="菠萝"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="菠萝"><span class="site-author-status" title="不想上学">😭</span></a><div class="site-author-name"><a href="/about/">菠萝</a></div><span class="site-name">牵风散步の雲</span><sub class="site-subtitle"></sub><div class="site-description"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="我的主页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">18</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">6</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">12</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/Kiritoabc" title="GitHub" target="_blank" style="color:#181717"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="2493381254@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=583001071" title="网易云音乐" target="_blank" style="color:#C10D0C"><span class="icon iconify" data-icon="ri:netease-cloud-music-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/160107797" title="哔哩哔哩动画" target="_blank" style="color:#FF8EB3"><span class="icon iconify" data-icon="ri:bilibili-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#flutter"><span class="toc-number">1.</span> <span class="toc-text">flutter</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%A1%86%E6%9E%B6dio-v5-3-3"><span class="toc-number">1.1.</span> <span class="toc-text">网络框架dio v5.3.3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E9%97%A8%E4%BD%BF%E7%94%A8"><span class="toc-number">1.1.1.</span> <span class="toc-text">入门使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dio-APIs"><span class="toc-number">1.1.2.</span> <span class="toc-text">Dio APIs</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AADio%E5%AE%9E%E4%BE%8B%E5%B9%B6%E9%85%8D%E7%BD%AE%E5%AE%83"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">创建一个Dio实例并配置它</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">请求配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">响应数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">拦截器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%88%90%E5%92%8C%E7%BB%88%E6%AD%A2%E8%AF%B7%E6%B1%82-%E5%93%8D%E5%BA%94"><span class="toc-number">1.1.2.5.</span> <span class="toc-text">完成和终止请求&#x2F;响应</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">1.1.2.6.</span> <span class="toc-text">日志拦截器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dart"><span class="toc-number">1.1.2.7.</span> <span class="toc-text">Dart</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Flutter"><span class="toc-number">1.1.2.8.</span> <span class="toc-text">Flutter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">1.1.2.9.</span> <span class="toc-text">自定义拦截器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.1.2.10.</span> <span class="toc-text">错误处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DioException"><span class="toc-number">1.1.2.11.</span> <span class="toc-text">DioException</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-application-x-www-form-urlencoded-%E7%BC%96%E7%A0%81"><span class="toc-number">1.1.2.12.</span> <span class="toc-text">使用 application&#x2F;x-www-form-urlencoded 编码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81-FormData"><span class="toc-number">1.1.2.13.</span> <span class="toc-text">发送 FormData</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.1.2.14.</span> <span class="toc-text">多文件上传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E7%94%A8-FormData-%E5%92%8C-MultipartFile"><span class="toc-number">1.1.2.15.</span> <span class="toc-text">复用 FormData 和 MultipartFile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-number">1.1.2.16.</span> <span class="toc-text">转换器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8-Flutter-%E4%B8%AD%E8%BF%9B%E8%A1%8C%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.1.2.17.</span> <span class="toc-text">在 Flutter 中进行设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.1.2.18.</span> <span class="toc-text">其它示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HttpClientAdapter"><span class="toc-number">1.1.2.19.</span> <span class="toc-text">HttpClientAdapter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86"><span class="toc-number">1.1.2.20.</span> <span class="toc-text">设置代理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTPS-%E8%AF%81%E4%B9%A6%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.1.2.21.</span> <span class="toc-text">HTTPS 证书校验</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-2-%E6%94%AF%E6%8C%81"><span class="toc-number">1.1.2.22.</span> <span class="toc-text">HTTP&#x2F;2 支持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%8F%96%E6%B6%88"><span class="toc-number">1.1.2.23.</span> <span class="toc-text">请求取消</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF-Dio-class"><span class="toc-number">1.1.2.24.</span> <span class="toc-text">继承 Dio class</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Web-%E5%B9%B3%E5%8F%B0%E8%B7%A8%E5%9F%9F%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB-CORS"><span class="toc-number">1.1.2.25.</span> <span class="toc-text">Web 平台跨域资源共享 (CORS)</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#6200ee;"><link itemprop="mainEntityOfPage" href="https://Kiritoabc.github.io/2023/11/13/Flutter/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="菠萝"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="牵风散步の雲"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">flutter</h1><div class="post-meta"><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="本文字数">4.6k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="阅读时长">20m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">安卓开发</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">安卓开发</span></a></span></div><div class="post-author"><div class="author-avatar"><img src="https://www.gravatar.com/avatar/5964a2fdb6bea3c102dd167bc34b1556?s=20&amp;d=https%3A%2F%2Fcdn.yunyoujun.cn%2Fimg%2Favatar%2Fnone.jpg"></div><span class="author-name">菠萝</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h1 id="flutter"><a href="#flutter" class="headerlink" title="flutter"></a>flutter</h1><h2 id="网络框架dio-v5-3-3"><a href="#网络框架dio-v5-3-3" class="headerlink" title="网络框架dio v5.3.3"></a>网络框架dio v5.3.3</h2><blockquote>
<p>dio 是一个强大的 HTTP 网络请求库，支持全局配置、Restful API、FormData、拦截器、 请求取消、Cookie 管理、文件上传&#x2F;下载、超时、自定义适配器、转换器等。</p>
</blockquote>
<span id="more"></span>

<h3 id="入门使用"><a href="#入门使用" class="headerlink" title="入门使用"></a>入门使用</h3><p>添加依赖</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutter pub add dio</span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:dio/dio.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> dio = Dio();</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> getHttp() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> response = <span class="keyword">await</span> dio.<span class="keyword">get</span>(<span class="string">&#x27;https://dart.dev&#x27;</span>);</span><br><span class="line">  <span class="built_in">print</span>(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>GET请求</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:dio/dio.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> dio = Dio();</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> request() <span class="keyword">async</span> &#123;</span><br><span class="line">  Response response;</span><br><span class="line">  response = <span class="keyword">await</span> dio.<span class="keyword">get</span>(<span class="string">&#x27;/test?id=12&amp;name=dio&#x27;</span>);</span><br><span class="line">  <span class="built_in">print</span>(response.data.toString());</span><br><span class="line">  <span class="comment">// The below request is the same as above.</span></span><br><span class="line">  response = <span class="keyword">await</span> dio.<span class="keyword">get</span>(</span><br><span class="line">    <span class="string">&#x27;/test&#x27;</span>,</span><br><span class="line">    queryParameters: &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">12</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dio&#x27;</span>&#125;,</span><br><span class="line">  );</span><br><span class="line">  <span class="built_in">print</span>(response.data.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>POST请求</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = <span class="keyword">await</span> dio.post(<span class="string">&#x27;/test&#x27;</span>, data: &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">12</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dio&#x27;</span>&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>发起多个并发的请求</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = <span class="keyword">await</span> Future.wait([dio.post(<span class="string">&#x27;/info&#x27;</span>), dio.<span class="keyword">get</span>(<span class="string">&#x27;/token&#x27;</span>)]);</span><br></pre></td></tr></table></figure>

<p><strong>下载文件</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">response = <span class="keyword">await</span> dio.download(</span><br><span class="line">  <span class="string">&#x27;https://www.google.com/&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;<span class="subst">$&#123;(await getTemporaryDirectory()).path&#125;</span>google.html&#x27;</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>以流的方式接收响应数据：</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> rs = <span class="keyword">await</span> dio.<span class="keyword">get</span>(</span><br><span class="line">  url,</span><br><span class="line">  options: Options(responseType: ResponseType.stream), <span class="comment">// 设置接收类型为 `stream`</span></span><br><span class="line">);</span><br><span class="line"><span class="built_in">print</span>(rs.data.stream); <span class="comment">// 响应流</span></span><br></pre></td></tr></table></figure>

<p><strong>以二进制数组的方式接收响应数据：</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> rs = <span class="keyword">await</span> dio.<span class="keyword">get</span>(</span><br><span class="line">  url,</span><br><span class="line">  options: Options(responseType: ResponseType.bytes), <span class="comment">// 设置接收类型为 `bytes`</span></span><br><span class="line">);</span><br><span class="line"><span class="built_in">print</span>(rs.data); <span class="comment">// 类型: List&lt;int&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>发送 <code>FormData</code>:</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> formData = FormData.fromMap(&#123;</span><br><span class="line">  <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dio&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;date&#x27;</span>: <span class="built_in">DateTime</span>.now().toIso8601String(),</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">final</span> response = <span class="keyword">await</span> dio.post(<span class="string">&#x27;/info&#x27;</span>, data: formData);</span><br></pre></td></tr></table></figure>

<p><strong>通过 <code>FormData</code> 上传多个文件:</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> formData = FormData.fromMap(&#123;</span><br><span class="line">  <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dio&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;date&#x27;</span>: <span class="built_in">DateTime</span>.now().toIso8601String(),</span><br><span class="line">  <span class="string">&#x27;file&#x27;</span>: <span class="keyword">await</span> MultipartFile.fromFile(<span class="string">&#x27;./text.txt&#x27;</span>, filename: <span class="string">&#x27;upload.txt&#x27;</span>),</span><br><span class="line">  <span class="string">&#x27;files&#x27;</span>: [</span><br><span class="line">    <span class="keyword">await</span> MultipartFile.fromFile(<span class="string">&#x27;./text1.txt&#x27;</span>, filename: <span class="string">&#x27;text1.txt&#x27;</span>),</span><br><span class="line">    <span class="keyword">await</span> MultipartFile.fromFile(<span class="string">&#x27;./text2.txt&#x27;</span>, filename: <span class="string">&#x27;text2.txt&#x27;</span>),</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">final</span> response = <span class="keyword">await</span> dio.post(<span class="string">&#x27;/info&#x27;</span>, data: formData);</span><br></pre></td></tr></table></figure>

<p><strong>监听发送（上传）数据进度:</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> response = <span class="keyword">await</span> dio.post(</span><br><span class="line">  <span class="string">&#x27;https://www.dtworkroom.com/doris/1/2.0.0/test&#x27;</span>,</span><br><span class="line">  data: &#123;<span class="string">&#x27;aa&#x27;</span>: <span class="string">&#x27;bb&#x27;</span> * <span class="number">22</span>&#125;,</span><br><span class="line">  onSendProgress: (<span class="built_in">int</span> sent, <span class="built_in">int</span> total) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;<span class="subst">$sent</span> <span class="subst">$total</span>&#x27;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>以流的形式提交二进制数据：</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Binary data</span></span><br><span class="line"><span class="keyword">final</span> postData = &lt;<span class="built_in">int</span>&gt;[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="keyword">await</span> dio.post(</span><br><span class="line">  url,</span><br><span class="line">  data: Stream.fromIterable(postData.map((e) =&gt; [e])), <span class="comment">// 构建 Stream&lt;List&lt;int&gt;&gt;</span></span><br><span class="line">  options: Options(</span><br><span class="line">    headers: &#123;</span><br><span class="line">      Headers.contentLengthHeader: postData.length, <span class="comment">// 设置 content-length.</span></span><br><span class="line">    &#125;,</span><br><span class="line">  ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="Dio-APIs"><a href="#Dio-APIs" class="headerlink" title="Dio APIs"></a>Dio APIs</h3><h4 id="创建一个Dio实例并配置它"><a href="#创建一个Dio实例并配置它" class="headerlink" title="创建一个Dio实例并配置它"></a>创建一个Dio实例并配置它</h4><blockquote>
<p>建议在项目中使用Dio单例，这样便可对同一个dio实例发起的所有请求进行一些统一的配置， 比如设置公共header、请求基地址、超时时间等。 这里有一个在<a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/example_flutter_app">Flutter工程中使用Dio单例</a> （定义为top level变量）的示例供开发者参考。</p>
</blockquote>
<p>你可以使用默认配置或传递一个可选 <code>BaseOptions</code>参数来创建一个Dio实例 :</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> dio = Dio(); <span class="comment">// With default `Options`.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> configureDio() &#123;</span><br><span class="line">  <span class="comment">// Update default configs.</span></span><br><span class="line">  dio.options.baseUrl = <span class="string">&#x27;https://api.pub.dev&#x27;</span>;</span><br><span class="line">  dio.options.connectTimeout = <span class="built_in">Duration</span>(seconds: <span class="number">5</span>);</span><br><span class="line">  dio.options.receiveTimeout = <span class="built_in">Duration</span>(seconds: <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Or create `Dio` with a `BaseOptions` instance.</span></span><br><span class="line">  <span class="keyword">final</span> options = BaseOptions(</span><br><span class="line">    baseUrl: <span class="string">&#x27;https://api.pub.dev&#x27;</span>,</span><br><span class="line">    connectTimeout: <span class="built_in">Duration</span>(seconds: <span class="number">5</span>),</span><br><span class="line">    receiveTimeout: <span class="built_in">Duration</span>(seconds: <span class="number">3</span>),</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">final</span> anotherDio = Dio(options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dio 的核心 API 是：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;Response&lt;T&gt;&gt; request&lt;T&gt;(</span><br><span class="line">  <span class="built_in">String</span> path, &#123;</span><br><span class="line">  <span class="built_in">Object?</span> data,</span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt;? queryParameters,</span><br><span class="line">  CancelToken? cancelToken,</span><br><span class="line">  Options? options,</span><br><span class="line">  ProgressCallback? onSendProgress,</span><br><span class="line">  ProgressCallback? onReceiveProgress,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> response = <span class="keyword">await</span> dio.request(</span><br><span class="line">  <span class="string">&#x27;/test&#x27;</span>,</span><br><span class="line">  data: &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">12</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dio&#x27;</span>&#125;,</span><br><span class="line">  options: Options(method: <span class="string">&#x27;GET&#x27;</span>),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="请求配置"><a href="#请求配置" class="headerlink" title="请求配置"></a>请求配置</h4><p><code>BaseOptions</code> 描述的是 Dio 实例发起网络请求的的公共配置， 而 <code>Options</code> 描述了每一个Http请求的配置信息，每一次请求都可以单独配置， 单次请求的 <code>Options</code> 中的配置信息可以覆盖 <code>BaseOptions</code> 中的配置。 下面是 <code>Options</code> 的配置项：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">请求方式。</span></span></span><br><span class="line"><span class="built_in">String</span> method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">请求基本地址，可以包含路径例如 https://dart.dev/api/。</span></span></span><br><span class="line"><span class="built_in">String?</span> baseUrl;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">HTTP 请求头。</span></span></span><br><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt;? headers;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">连接服务器超时时间.</span></span></span><br><span class="line"><span class="built_in">Duration?</span> connectTimeout;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">两次数据流数据接收的最长间隔时间，注意不是请求的最长接收时间。</span></span></span><br><span class="line"><span class="built_in">Duration?</span> receiveTimeout;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">请求内容体，可以是任意类型。</span></span></span><br><span class="line"><span class="built_in">dynamic</span> data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">请求路径，如果以 http(s)开始, 则 [baseURL] 会被忽略，</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">否则将会和 [baseUrl] 拼接出完整的地址。</span></span></span><br><span class="line"><span class="built_in">String</span> path = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">请求的 Content-Type。</span></span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">默认值会由 [ImplyContentTypeInterceptor] 根据请求载荷类型进行推导。</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">可以调用 [Interceptors.removeImplyContentTypeInterceptor] 进行移除。</span></span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">如果你想以 <span class="code">`application/x-www-form-urlencoded`</span> 格式编码请求数据,</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">可以设置此选项为 <span class="code">`Headers.formUrlEncodedContentType`</span>,</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">[Dio] 会自动编码请求体。</span></span></span><br><span class="line"><span class="built_in">String?</span> contentType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">期望以哪种格式（方式）接受响应数据，包括 <span class="code">`json`</span>、<span class="code">`stream`</span> 和 <span class="code">`plain`</span>。</span></span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">默认值是 <span class="code">`json`</span>, 当响应头中 content-type 为 <span class="code">`application/json`</span> 时，</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">dio 会自动将响应内容转化为 json 对象。</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">如果想以二进制方式接受响应数据，如下载一个二进制文件，那么可以使用 <span class="code">`stream`</span>。</span></span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">如果想以文本（字符串）格式接收响应数据，请使用 <span class="code">`plain`</span>。</span></span></span><br><span class="line">ResponseType? responseType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">`validateStatus`</span> 决定 HTTP 响应状态码是否被视为请求成功，</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">返回 <span class="code">`true`</span> 请求结果就会按成功处理，否则会按失败处理.</span></span></span><br><span class="line">ValidateStatus? validateStatus;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">用户自定义字段，可以在 [Interceptor]、[Transformer] 和 [Response] 中依次传递。</span></span></span><br><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt;? extra;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">请求地址的参数。</span></span></span><br><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span> <span class="comment">/*String|Iterable&lt;String&gt;*/</span> &gt;? queryParameters;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">请求数据中数组的编码的方式，默认值为 <span class="code">`multiCompatible`</span>。</span></span></span><br><span class="line">ListFormat? listFormat;</span><br></pre></td></tr></table></figure>

<h4 id="响应数据"><a href="#响应数据" class="headerlink" title="响应数据"></a>响应数据</h4><p>当请求成功时会返回一个Response对象，它包含如下字段：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">响应数据。可能已经被转换了类型, 详情请参考 [ResponseType]。</span></span></span><br><span class="line">T? data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">响应对应的请求配置。</span></span></span><br><span class="line">RequestOptions requestOptions;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">响应的 HTTP 状态码。</span></span></span><br><span class="line"><span class="built_in">int?</span> statusCode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">响应对应状态码的详情信息。</span></span></span><br><span class="line"><span class="built_in">String?</span> statusMessage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">响应是否被重定向</span></span></span><br><span class="line"><span class="built_in">bool</span> isRedirect;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">请求连接经过的重定向列表。如果请求未经过重定向，则列表为空。</span></span></span><br><span class="line"><span class="built_in">List</span>&lt;RedirectRecord&gt; redirects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">在 [RequestOptions] 中构造的自定义字段。</span></span></span><br><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; extra;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">响应对应的头数据。</span></span></span><br><span class="line">Headers headers;</span><br></pre></td></tr></table></figure>

<p>请求成功后，你可以访问到下列字段：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> response = <span class="keyword">await</span> dio.<span class="keyword">get</span>(<span class="string">&#x27;https://pub.dev&#x27;</span>);</span><br><span class="line"><span class="built_in">print</span>(response.data);</span><br><span class="line"><span class="built_in">print</span>(response.headers);</span><br><span class="line"><span class="built_in">print</span>(response.requestOptions);</span><br><span class="line"><span class="built_in">print</span>(response.statusCode);</span><br></pre></td></tr></table></figure>



<p>注意，<code>Response.extra</code> 与 <code>RequestOptions.extra</code> 是不同的实例，互相之间无关。</p>
<h4 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h4><p>每个 Dio 实例都可以添加任意多个拦截器，他们会组成一个队列，拦截器队列的执行顺序是先进先出。 通过使用拦截器，你可以在请求之前、响应之后和发生异常时（未被 <code>then</code> 或 <code>catchError</code> 处理） 做一些统一的预处理操作。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">dio.interceptors.add(</span><br><span class="line">  InterceptorsWrapper(</span><br><span class="line">    onRequest: (RequestOptions options, RequestInterceptorHandler handler) &#123;</span><br><span class="line">      <span class="comment">// 如果你想完成请求并返回一些自定义数据，你可以使用 `handler.resolve(response)`。</span></span><br><span class="line">      <span class="comment">// 如果你想终止请求并触发一个错误，你可以使用 `handler.reject(error)`。</span></span><br><span class="line">      <span class="keyword">return</span> handler.next(options);</span><br><span class="line">    &#125;,</span><br><span class="line">    onResponse: (Response response, ResponseInterceptorHandler handler) &#123;</span><br><span class="line">      <span class="comment">// 如果你想终止请求并触发一个错误，你可以使用 `handler.reject(error)`。</span></span><br><span class="line">      <span class="keyword">return</span> handler.next(response);</span><br><span class="line">    &#125;,</span><br><span class="line">    onError: (DioException e, ErrorInterceptorHandler handler) &#123;</span><br><span class="line">      <span class="comment">// 如果你想完成请求并返回一些自定义数据，你可以使用 `handler.resolve(response)`。</span></span><br><span class="line">      <span class="keyword">return</span> handler.next(e);</span><br><span class="line">    &#125;,</span><br><span class="line">  ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>一个简单的自定义拦截器示例:</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:dio/dio.dart&#x27;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomInterceptors</span> <span class="keyword">extends</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> onRequest(RequestOptions options, RequestInterceptorHandler handler) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;REQUEST[<span class="subst">$&#123;options.method&#125;</span>] =&gt; PATH: <span class="subst">$&#123;options.path&#125;</span>&#x27;</span>);</span><br><span class="line">    <span class="keyword">super</span>.onRequest(options, handler);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> onResponse(Response response, ResponseInterceptorHandler handler) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;RESPONSE[<span class="subst">$&#123;response.statusCode&#125;</span>] =&gt; PATH: <span class="subst">$&#123;response.requestOptions.path&#125;</span>&#x27;</span>);</span><br><span class="line">    <span class="keyword">super</span>.onResponse(response, handler);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future onError(DioException err, ErrorInterceptorHandler handler) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ERROR[<span class="subst">$&#123;err.response?.statusCode&#125;</span>] =&gt; PATH: <span class="subst">$&#123;err.requestOptions.path&#125;</span>&#x27;</span>);</span><br><span class="line">    <span class="keyword">super</span>.onError(err, handler);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="完成和终止请求-响应"><a href="#完成和终止请求-响应" class="headerlink" title="完成和终止请求&#x2F;响应"></a>完成和终止请求&#x2F;响应</h4><p>在所有拦截器中，你都可以改变请求执行流， 如果你想完成请求&#x2F;响应并返回自定义数据，你可以 resolve 一个 <code>Response</code> 对象 或返回 <code>handler.resolve(data)</code> 的结果。 如果你想终止（触发一个错误，上层 <code>catchError</code> 会被调用）一个请求&#x2F;响应， 那么可以 reject 一个<code>DioException</code> 对象或返回 <code>handler.reject(errMsg)</code> 的结果。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dio.interceptors.add(</span><br><span class="line">  InterceptorsWrapper(</span><br><span class="line">    onRequest: (options, handler) &#123;</span><br><span class="line">      <span class="keyword">return</span> handler.resolve(</span><br><span class="line">        Response(requestOptions: options, data: <span class="string">&#x27;fake data&#x27;</span>),</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br><span class="line">  ),</span><br><span class="line">);</span><br><span class="line"><span class="keyword">final</span> response = <span class="keyword">await</span> dio.<span class="keyword">get</span>(<span class="string">&#x27;/test&#x27;</span>);</span><br><span class="line"><span class="built_in">print</span>(response.data); <span class="comment">// &#x27;fake data&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果同时发起多个网络请求，则它们是可以同时进入<code>Interceptor</code> 的（并行的）， 而 <code>QueuedInterceptor</code> 提供了一种串行机制： 它可以保证请求进入拦截器时是串行的（前面的执行完后后面的才会进入拦截器）。</p>
<p>假设这么一个场景：出于安全原因，我们需要给所有的请求头中添加一个 <code>csrfToken</code>， 如果 <code>csrfToken</code> 不存在，我们先去请求 <code>csrfToken</code>，获取到 <code>csrfToken</code> 后再重试。 假设刚开始的时候 <code>csrfToken</code> 为 null，如果允许请求并发，则这些并发请求并行进入拦截器时 <code>csrfToken</code> 都为 null，所以它们都需要去请求 <code>csrfToken</code>，这会导致 <code>csrfToken</code> 被请求多次。 为了避免不必要的重复请求，可以使用 <code>QueuedInterceptor</code>， 这样只需要第一个请求处理一次即可。</p>
<p>完整的示例代码请点击 <a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/example/lib/queued_interceptor_crsftoken.dart">这里</a>.</p>
<h4 id="日志拦截器"><a href="#日志拦截器" class="headerlink" title="日志拦截器"></a>日志拦截器</h4><p>我们可以添加 <code>LogInterceptor</code> 拦截器来自动打印请求和响应等日志：</p>
<p><strong>注意：</strong> <code>LogInterceptor</code> 应该保持最后一个被添加到拦截器中， 否则在它之后进行处理的拦截器修改的内容将无法体现。</p>
<h4 id="Dart"><a href="#Dart" class="headerlink" title="Dart"></a>Dart</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dio.interceptors.add(LogInterceptor(responseBody: <span class="keyword">false</span>)); <span class="comment">// 不输出响应内容体</span></span><br></pre></td></tr></table></figure>



<p><strong>注意：</strong> 默认的 <code>logPrint</code> 只会在 DEBUG 模式（启用了断言） 的情况下输出日志。</p>
<p>你也可以使用 <code>dart:developer</code> 中的 <code>log</code> 来输出日志（在 Flutter 中也可以使用）。</p>
<h4 id="Flutter"><a href="#Flutter" class="headerlink" title="Flutter"></a>Flutter</h4><p>在 Flutter 中你应该使用 <code>debugPrint</code> 来打印日志。</p>
<p>这样也会让调试日志能够通过 <code>flutter logs</code> 获取到。</p>
<p><strong>注意：</strong> <code>debugPrint</code> 的意义 <strong>不是只在 DEBUG 模式下打印</strong>， 而是对输出内容进行节流，从而保证输出完整。 请不要在生产模式使用，除非你有意输出相关日志。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dio.interceptors.add(</span><br><span class="line">  LogInterceptor(</span><br><span class="line">    logPrint: (o) =&gt; debugPrint(o.toString()),</span><br><span class="line">  ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<h4 id="自定义拦截器"><a href="#自定义拦截器" class="headerlink" title="自定义拦截器"></a>自定义拦截器</h4><p>开发者可以通过继承 <code>Interceptor/QueuedInterceptor</code> 类来实现自定义拦截器。 这是一个简单的 <a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/example/lib/custom_cache_interceptor.dart">缓存拦截器</a>。</p>
<h4 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h4><p>当请求过程中发生错误时, Dio 会将 <code>Error/Exception</code> 包装成一个 <code>DioException</code>:</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// 404</span></span><br><span class="line">  <span class="keyword">await</span> dio.<span class="keyword">get</span>(<span class="string">&#x27;https://api.pub.dev/not-exist&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">on</span> DioException <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="comment">// The request was made and the server responded with a status code</span></span><br><span class="line">  <span class="comment">// that falls out of the range of 2xx and is also not 304.</span></span><br><span class="line">  <span class="keyword">if</span> (e.response != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(e.response.data)</span><br><span class="line">    <span class="built_in">print</span>(e.response.headers)</span><br><span class="line">    <span class="built_in">print</span>(e.response.requestOptions)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Something happened in setting up or sending the request that triggered an Error</span></span><br><span class="line">    <span class="built_in">print</span>(e.requestOptions)</span><br><span class="line">    <span class="built_in">print</span>(e.message)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DioException"><a href="#DioException" class="headerlink" title="DioException"></a>DioException</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">错误的请求对应的配置。</span></span></span><br><span class="line">RequestOptions requestOptions;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">错误的请求对应的响应内容。如果请求未完成，响应内容可能为空。</span></span></span><br><span class="line">Response? response;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">错误的类型。</span></span></span><br><span class="line">DioExceptionType type;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">实际错误的内容。</span></span></span><br><span class="line"><span class="built_in">Object?</span> error;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">实际错误的堆栈。</span></span></span><br><span class="line">StackTrace? stackTrace;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">错误信息。</span></span></span><br><span class="line"><span class="built_in">String?</span> message;</span><br></pre></td></tr></table></figure>

<h4 id="使用-application-x-www-form-urlencoded-编码"><a href="#使用-application-x-www-form-urlencoded-编码" class="headerlink" title="使用 application&#x2F;x-www-form-urlencoded 编码"></a>使用 application&#x2F;x-www-form-urlencoded 编码</h4><p>默认情况下, Dio 会将请求数据（除了 <code>String</code> 类型）序列化为 JSON。 如果想要以 <code>application/x-www-form-urlencoded</code> 格式编码, 你可以设置 <code>contentType</code> :</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Instance level</span></span><br><span class="line">dio.options.contentType = Headers.formUrlEncodedContentType;</span><br><span class="line"><span class="comment">// or only works once</span></span><br><span class="line">dio.post(</span><br><span class="line">  <span class="string">&#x27;/info&#x27;</span>,</span><br><span class="line">  data: &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">5</span>&#125;,</span><br><span class="line">  options: Options(contentType: Headers.formUrlEncodedContentType),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="发送-FormData"><a href="#发送-FormData" class="headerlink" title="发送 FormData"></a><a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/dio/README-ZH.md#%E5%8F%91%E9%80%81-formdata">发送 FormData</a></h4><p>Dio 支持发送 <code>FormData</code>, 请求数据将会以 <code>multipart/form-data</code> 方式编码, <code>FormData</code> 中可以包含一个或多个文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">final formData = FormData.fromMap(&#123;</span><br><span class="line">  &#x27;name&#x27;: &#x27;dio&#x27;,</span><br><span class="line">  &#x27;date&#x27;: DateTime.now().toIso8601String(),</span><br><span class="line">  &#x27;file&#x27;: await MultipartFile.fromFile(&#x27;./text.txt&#x27;,filename: &#x27;upload.txt&#x27;)</span><br><span class="line">&#125;);</span><br><span class="line">final response = await dio.post(&#x27;/info&#x27;, data: formData);</span><br></pre></td></tr></table></figure>



<blockquote>
<p>通常情况下只有 POST 方法支持发送 FormData。</p>
</blockquote>
<p>这里有一个完整的 <a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/example/lib/formdata.dart">示例</a>。</p>
<h4 id="多文件上传"><a href="#多文件上传" class="headerlink" title="多文件上传"></a><a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/dio/README-ZH.md#%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0">多文件上传</a></h4><p>多文件上传时，通过给 key 加中括号 <code>[]</code> 方式作为文件数组的标记，大多数后台也会通过 <code>key[]</code> 来读取多个文件。 然而 RFC 标准中并没有规定多文件上传必须要使用 <code>[]</code>，关键在于后台与客户端之间保持一致。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">final formData = FormData.fromMap(&#123;</span><br><span class="line">  &#x27;files&#x27;: [</span><br><span class="line">    MultipartFile.fromFileSync(&#x27;path/to/upload1.txt&#x27;, filename: &#x27;upload1.txt&#x27;),</span><br><span class="line">    MultipartFile.fromFileSync(&#x27;path/to/upload2.txt&#x27;, filename: &#x27;upload2.txt&#x27;),</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p>最终编码时会 key 会为 <code>files[]</code>， **如果不想添加 []**，可以通过 <code>Formdata</code> 的 <code>files</code> 来构建：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">final formData = FormData();</span><br><span class="line">formData.files.addAll([</span><br><span class="line">  MapEntry(</span><br><span class="line">   &#x27;files&#x27;,</span><br><span class="line">    MultipartFile.fromFileSync(&#x27;./example/upload.txt&#x27;,filename: &#x27;upload.txt&#x27;),</span><br><span class="line">  ),</span><br><span class="line">  MapEntry(</span><br><span class="line">    &#x27;files&#x27;,</span><br><span class="line">    MultipartFile.fromFileSync(&#x27;./example/upload.txt&#x27;,filename: &#x27;upload.txt&#x27;),</span><br><span class="line">  ),</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>



<h4 id="复用-FormData-和-MultipartFile"><a href="#复用-FormData-和-MultipartFile" class="headerlink" title="复用 FormData 和 MultipartFile"></a>复用 <code>FormData</code> 和 <code>MultipartFile</code></h4><p>如果你在重复调用的请求中使用 <code>FormData</code> 或者 <code>MultipartFile</code>，确保你每次使用的都是新实例。 常见的错误做法是将 <code>FormData</code> 赋值给一个共享变量，在每次请求中都使用这个变量。 这样的操作会加大 <strong>无法序列化</strong> 的错误出现的可能性。 你可以像以下的代码一样编写你的请求以避免出现这样的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;void&gt; _repeatedlyRequest() async &#123;</span><br><span class="line">  Future&lt;FormData&gt; createFormData() async &#123;</span><br><span class="line">    return FormData.fromMap(&#123;</span><br><span class="line">      &#x27;name&#x27;: &#x27;dio&#x27;,</span><br><span class="line">      &#x27;date&#x27;: DateTime.now().toIso8601String(),</span><br><span class="line">      &#x27;file&#x27;: await MultipartFile.fromFile(&#x27;./text.txt&#x27;,filename: &#x27;upload.txt&#x27;),</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  await dio.post(&#x27;some-url&#x27;, data: await createFormData());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="转换器"><a href="#转换器" class="headerlink" title="转换器"></a>转换器</h4><p>转换器 <code>Transformer</code> 用于对请求数据和响应数据进行编解码处理。 Dio 实现了一个默认转换器 <code>DefaultTransformer</code>。 如果你想对请求和响应数据进行自定义编解码处理，可以提供自定义转换器并通过 <code>dio.transformer</code> 设置。</p>
<blockquote>
<p><code>Transformer.transformRequest</code> 只在 <code>PUT</code>&#x2F;<code>POST</code>&#x2F;<code>PATCH</code> 方法中生效， 只有这些方法可以使用请求内容体 (request body)。 但是 <code>Transformer.transformResponse</code> 可以用于所有请求方法的返回数据。</p>
</blockquote>
<h4 id="在-Flutter-中进行设置"><a href="#在-Flutter-中进行设置" class="headerlink" title="在 Flutter 中进行设置"></a>在 Flutter 中进行设置</h4><p>如果你在开发 Flutter 应用，强烈建议通过 <code>compute</code> 在单独的 isolate 中进行 JSON 解码， 从而避免在解析复杂 JSON 时导致的 UI 卡顿。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/// </span><br><span class="line">Map&lt;String, dynamic&gt; _parseAndDecode(String response) &#123;</span><br><span class="line">  return jsonDecode(response) as Map&lt;String, dynamic&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Future&lt;Map&lt;String, dynamic&gt;&gt; parseJson(String text) &#123;</span><br><span class="line">  return compute(_parseAndDecode, text);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main() &#123;</span><br><span class="line">  // 自定义 `jsonDecodeCallback`</span><br><span class="line">  dio.transformer = DefaultTransformer()..jsonDecodeCallback = parseJson;</span><br><span class="line">  runApp(MyApp());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="其它示例"><a href="#其它示例" class="headerlink" title="其它示例"></a>其它示例</h4><p>这里有一个 <a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/example/lib/transformer.dart">自定义 Transformer 的示例</a>。</p>
<h4 id="HttpClientAdapter"><a href="#HttpClientAdapter" class="headerlink" title="HttpClientAdapter"></a>HttpClientAdapter</h4><p><code>HttpClientAdapter</code> 是 <code>Dio</code> 和 <code>HttpClient</code> 之间的桥梁。</p>
<p><code>Dio</code> 实现了一套标准且强大的 API，而 <code>HttpClient</code> 则是真正发起 HTTP 请求的对象。</p>
<p>我们通过 <code>HttpClientAdapter</code> 将 <code>Dio</code> 和 <code>HttpClient</code> 解耦， 这样一来便可以自由定制 HTTP 请求的底层实现。 Dio 使用 <code>IOHttpClientAdapter</code> 作为原生平台默认的桥梁， <code>BrowserClientAdapter</code> 作为 Web 平台的桥梁。 你可以通过 <code>HttpClientAdapter()</code> 来根据平台创建它们。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dio.httpClientAdapter = HttpClientAdapter();</span><br></pre></td></tr></table></figure>



<p>如果你需要单独使用对应平台的适配器：</p>
<ul>
<li><p>对于 Web 平台</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import &#x27;package:dio/browser.dart&#x27;;</span><br><span class="line">// ...</span><br><span class="line">dio.httpClientAdapter = BrowserClientAdapter();</span><br></pre></td></tr></table></figure>


</li>
<li><p>对于原生平台：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import &#x27;package:dio/io.dart&#x27;;</span><br><span class="line">// ...</span><br><span class="line">dio.httpClientAdapter = IOClientAdapter();</span><br></pre></td></tr></table></figure></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/example/lib/adapter.dart">示例</a> 中包含了一个简单的自定义桥接。</p>
<h4 id="设置代理"><a href="#设置代理" class="headerlink" title="设置代理"></a><a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/dio/README-ZH.md#%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86">设置代理</a></h4><p><code>IOHttpClientAdapter</code> 提供了一个 <code>createHttpClient</code> 回调来设置底层 <code>HttpClient</code> 的代理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import &#x27;package:dio/io.dart&#x27;;</span><br><span class="line"></span><br><span class="line">void initAdapter() &#123;</span><br><span class="line">  dio.httpClientAdapter = IOHttpClientAdapter(</span><br><span class="line">    createHttpClient: () &#123;</span><br><span class="line">      final client = HttpClient();</span><br><span class="line">      client.findProxy = (uri) &#123;</span><br><span class="line">        // 将请求代理至 localhost:8888。</span><br><span class="line">        // 请注意，代理会在你正在运行应用的设备上生效，而不是在宿主平台生效。</span><br><span class="line">        return &#x27;PROXY localhost:8888&#x27;;</span><br><span class="line">      &#125;;</span><br><span class="line">      return client;</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>完整的示例请查看 <a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/example/lib/proxy.dart">这里</a>。</p>
<p>Web 平台不支持设置代理。</p>
<h4 id="HTTPS-证书校验"><a href="#HTTPS-证书校验" class="headerlink" title="HTTPS 证书校验"></a><a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/dio/README-ZH.md#https-%E8%AF%81%E4%B9%A6%E6%A0%A1%E9%AA%8C">HTTPS 证书校验</a></h4><p>HTTPS 证书验证（或公钥固定）是指确保端侧与服务器的 TLS 连接的证书是期望的证书，从而减少中间人攻击的机会。 <a target="_blank" rel="noopener" href="https://owasp.org/www-community/controls/Certificate_and_Public_Key_Pinning">OWASP</a> 中解释了该理论。</p>
<p><strong>服务器响应证书</strong></p>
<p>与其他方法不同，此方法使用服务器本身的证书。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">void initAdapter() &#123;</span><br><span class="line">  const String fingerprint = &#x27;ee5ce1dfa7a53657c545c62b65802e4272878dabd65c0aadcf85783ebb0b4d5c&#x27;;</span><br><span class="line">  dio.httpClientAdapter = IOHttpClientAdapter(</span><br><span class="line">    createHttpClient: () &#123;</span><br><span class="line">      // Don&#x27;t trust any certificate just because their root cert is trusted.</span><br><span class="line">      final HttpClient client = HttpClient(context: SecurityContext(withTrustedRoots: false));</span><br><span class="line">      // You can test the intermediate / root cert here. We just ignore it.</span><br><span class="line">      client.badCertificateCallback = (cert, host, port) =&gt; true;</span><br><span class="line">      return client;</span><br><span class="line">    &#125;,</span><br><span class="line">    validateCertificate: (cert, host, port) &#123;</span><br><span class="line">      // Check that the cert fingerprint matches the one we expect.</span><br><span class="line">      // We definitely require _some_ certificate.</span><br><span class="line">      if (cert == null) &#123;</span><br><span class="line">        return false;</span><br><span class="line">      &#125;</span><br><span class="line">      // Validate it any way you want. Here we only check that</span><br><span class="line">      // the fingerprint matches the OpenSSL SHA256.</span><br><span class="line">      return fingerprint == sha256.convert(cert.der).toString();</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>你可以使用 OpenSSL 读取密钥的 SHA-256：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl s_client -servername pinning-test.badssl.com -connect pinning-test.badssl.com:443 &lt; /dev/null 2&gt;/dev/null \</span><br><span class="line">  | openssl x509 -noout -fingerprint -sha256</span><br><span class="line"></span><br><span class="line">#### SHA256 Fingerprint=EE:5C:E1:DF:A7:A5:36:57:C5:45:C6:2B:65:80:2E:42:72:87:8D:AB:D6:5C:0A:AD:CF:85:78:3E:BB:0B:4D:5C</span><br><span class="line"># (remove the formatting, keep only lower case hex characters to match the `sha256` above)</span><br></pre></td></tr></table></figure>



<p><strong>证书颁发机构验证</strong></p>
<p>当您的服务器具有自签名证书时，可以用下面的方法，但它们不适用于 AWS 或 Let’s Encrypt 等第三方颁发的证书。</p>
<p>有两种方法可以校验证书，假设我们的后台服务使用的是自签名证书，证书格式是 PEM 格式，我们将证书的内容保存在本地字符串中， 那么我们的校验逻辑如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">void initAdapter() &#123;</span><br><span class="line">  String PEM = &#x27;XXXXX&#x27;; // root certificate content</span><br><span class="line">  dio.httpClientAdapter = IOHttpClientAdapter(</span><br><span class="line">    createHttpClient: () &#123;</span><br><span class="line">      final client = HttpClient();</span><br><span class="line">      client.badCertificateCallback = (X509Certificate cert, String host, int port) &#123;</span><br><span class="line">        return cert.pem == PEM; // Verify the certificate.</span><br><span class="line">      &#125;;</span><br><span class="line">      return client;</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>对于自签名的证书，我们也可以将其添加到本地证书信任链中， 这样证书验证时就会自动通过，而不会再走到 <code>badCertificateCallback</code> 回调中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void initAdapter() &#123;</span><br><span class="line">  String PEM = &#x27;XXXXX&#x27;; // root certificate content</span><br><span class="line">  dio.httpClientAdapter = IOHttpClientAdapter(</span><br><span class="line">    onHttpClientCreate: (_) &#123;</span><br><span class="line">      final SecurityContext sc = SecurityContext();</span><br><span class="line">      sc.setTrustedCertificates(File(pathToTheCertificate));</span><br><span class="line">      final HttpClient client = HttpClient(context: sc);</span><br><span class="line">      return client;</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>注意，通过 <code>setTrustedCertificates()</code> 设置的证书格式必须为 PEM 或 PKCS12， 如果证书格式为 PKCS12，则需将证书密码传入， 这样则会在代码中暴露证书密码，所以客户端证书校验不建议使用 PKCS12 格式的证书。</p>
<h4 id="HTTP-2-支持"><a href="#HTTP-2-支持" class="headerlink" title="HTTP&#x2F;2 支持"></a><a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/dio/README-ZH.md#http2-%E6%94%AF%E6%8C%81">HTTP&#x2F;2 支持</a></h4><p><a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/plugins/http2_adapter">dio_http2_adapter</a> 提供了一个支持 HTTP&#x2F;2 的桥接 。</p>
<h4 id="请求取消"><a href="#请求取消" class="headerlink" title="请求取消"></a>请求取消</h4><p>你可以通过 <code>CancelToken</code> 来取消发起的请求。 一个 <code>CancelToken</code> 可以给多个请求共用， 在共用时调用 <code>cancel()</code> 会取消对应的所有请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">final cancelToken = CancelToken();</span><br><span class="line">dio.get(url, cancelToken: cancelToken).catchError((DioException err) &#123;</span><br><span class="line">  if (CancelToken.isCancel(err)) &#123;</span><br><span class="line">    print(&#x27;Request canceled: $&#123;err.message&#125;&#x27;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // handle error.</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">// Cancel the requests with &quot;cancelled&quot; message.</span><br><span class="line">token.cancel(&#x27;cancelled&#x27;);</span><br></pre></td></tr></table></figure>



<p>完整的示例请参考 <a target="_blank" rel="noopener" href="https://github.com/cfug/dio/blob/main/example/lib/cancel_request.dart">取消示例</a>.</p>
<h4 id="继承-Dio-class"><a href="#继承-Dio-class" class="headerlink" title="继承 Dio class"></a>继承 Dio class</h4><p><code>Dio</code> 是一个拥有工厂构造函数的接口类，因此不能直接继承 <code>Dio</code>， 但是可以继承 <code>DioForNative</code> 或 <code>DioForBrowser</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import &#x27;package:dio/dio.dart&#x27;;</span><br><span class="line">import &#x27;package:dio/io.dart&#x27;;</span><br><span class="line">// 在浏览器中，导入 &#x27;package:dio/browser.dart&#x27;。</span><br><span class="line"></span><br><span class="line">class Http extends DioForNative &#123;</span><br><span class="line">  Http([BaseOptions options]) : super(options) &#123;</span><br><span class="line">    // 构造函数执行</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>我们也可以直接实现 <code>Dio</code> 接口类 :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class MyDio with DioMixin implements Dio &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Web-平台跨域资源共享-CORS"><a href="#Web-平台跨域资源共享-CORS" class="headerlink" title="Web 平台跨域资源共享 (CORS)"></a>Web 平台跨域资源共享 (CORS)</h4><p>在 Web 平台上发送网络请求时，如果请求不是一个 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS#%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82">简单请求</a>， 浏览器会自动向服务器发送 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/Preflight_request">CORS 预检</a> (Pre-flight requests)， 用于检查服务器是否支持跨域资源共享。</p>
<p>你可以参考简单请求的定义修改你的请求，或者为你的服务加上 CORS 中间件进行跨域处理。</p>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><span class="icon iconify" data-icon="ri:hand-coin-line"></span></span><div id="reward-comment">I'm so cute. Please give me money.</div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>菠萝</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://kiritoabc.github.io/2023/11/13/Flutter/" title="flutter">https://kiritoabc.github.io/2023/11/13/Flutter/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2023/11/13/Docker/" rel="prev" title="Docker基础"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">Docker基础</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2023/11/13/Go%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="next" title="Go面试题"><span class="post-nav-text">Go面试题</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2023 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> 菠萝</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v7.0.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#6200ee" stroke-width="2" stroke-linecap="round"></circle></svg></a><script>function initMourn() {
  const date = new Date();
  const today = (date.getMonth() + 1) + "-" + date.getDate()
  const mourn_days = ["4-4","9-18"]
  if (mourn_days.includes(today)) {
    document.documentElement.style.filter = "grayscale(1)";
  }
}
initMourn();</script><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style></body></html>